name: Restart API Gateway

on:
  workflow_dispatch:
  
  # Optionally, you can schedule periodic restarts
  # schedule:
  #   - cron: '0 2 * * *'  # Daily at 2 AM UTC

jobs:
  restart-api-gateway:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Install sshpass
        run: sudo apt-get update && sudo apt-get install -y sshpass
      
      - name: Check Required Environment Variables
        run: |
          echo "üîç Checking required environment variables..."
          MISSING_VARS=""
          
          # List of required variables
          REQUIRED_VARS=(
            "API_GATEWAY_SERVER_USER"
            "API_GATEWAY_SERVER_PASSWORD"
            "API_GATEWAY_SERVER_HOST"
            "API_GATEWAY_SERVER_PORT"
            "API_GATEWAY_SERVER_ROOT_PATH"
            "API_GATEWAY_SERVER_DOCKER_COMPOSE_PATH"
          )
          
          for var in "${REQUIRED_VARS[@]}"; do
            if [ -z "${!var}" ]; then
              MISSING_VARS="$MISSING_VARS $var"
              echo "‚ùå Missing: $var"
            else
              echo "‚úÖ Found: $var"
            fi
          done
          
          if [ ! -z "$MISSING_VARS" ]; then
            echo ""
            echo "‚ùå Missing required environment variables:$MISSING_VARS"
            echo "Please configure these secrets in your GitHub repository settings."
            echo "Run: node scripts/configure-github-secrets.mjs"
            exit 1
          fi
          
          echo "‚úÖ All required environment variables are configured"
        env:
          API_GATEWAY_SERVER_USER: ${{ secrets.API_GATEWAY_SERVER_USER }}
          API_GATEWAY_SERVER_PASSWORD: ${{ secrets.API_GATEWAY_SERVER_PASSWORD }}
          API_GATEWAY_SERVER_HOST: ${{ secrets.API_GATEWAY_SERVER_HOST }}
          API_GATEWAY_SERVER_PORT: ${{ secrets.API_GATEWAY_SERVER_PORT }}
          API_GATEWAY_SERVER_ROOT_PATH: ${{ secrets.API_GATEWAY_SERVER_ROOT_PATH }}
          API_GATEWAY_SERVER_DOCKER_COMPOSE_PATH: ${{ secrets.API_GATEWAY_SERVER_DOCKER_COMPOSE_PATH }}
      
      - name: Restart API Gateway with Log Backup
        env:
          SSHPASS: ${{ secrets.API_GATEWAY_SERVER_PASSWORD }}
        run: |
          echo "Restarting API Gateway on ${{ secrets.API_GATEWAY_SERVER_HOST }}..."
          
          # Create a formatted script and execute it via SSH  
          SCRIPT="
            clear 2>/dev/null || true
            
            # Create timestamp for unique file names (using only dashes)
            TIMESTAMP=\$(date +\"%Y-%m-%d-%H-%M-%S\")
            LOGS_FILENAME=\"api-gateway-logs-\${TIMESTAMP}.tar.gz\"
            
            echo \"üì∏ 1. Creating log snapshot before restart...\"
            # Navigate to the project directory first to get correct container name
            cd ${{ secrets.API_GATEWAY_SERVER_ROOT_PATH }}
            
            # Debug: Show all containers first
            echo \"üîç DEBUG: Current containers:\"
            docker-compose -f ${{ secrets.API_GATEWAY_SERVER_DOCKER_COMPOSE_PATH }} ps
            
            # Get the container name from docker-compose ps output (look for running containers)
            CONTAINER_NAME=\$(docker-compose -f ${{ secrets.API_GATEWAY_SERVER_DOCKER_COMPOSE_PATH }} ps -q --filter \"status=running\" | head -1)
            
            echo \"üîç DEBUG: Found container ID: '\$CONTAINER_NAME'\"
            
            if [ ! -z \"\$CONTAINER_NAME\" ]; then
              # Backup logs from the running container
              docker logs \$CONTAINER_NAME --timestamps > ~/api-gateway-logs-\${TIMESTAMP}.txt 2>&1
              
              # Archive the logs
              tar -czvf ~/\${LOGS_FILENAME} -C ~ api-gateway-logs-\${TIMESTAMP}.txt
              
              # Remove temporary log file
              rm ~/api-gateway-logs-\${TIMESTAMP}.txt
              
              echo \"üíæ Log snapshot saved as: ~/\${LOGS_FILENAME}\"
              LOG_BACKUP_CREATED=\"true\"
            else
              echo \"‚ÑπÔ∏è  No running container found, skipping log backup\"
              LOG_BACKUP_CREATED=\"false\"
            fi
            
            echo \"‚èπÔ∏è  2. Stopping existing containers...\"
            docker-compose -f ${{ secrets.API_GATEWAY_SERVER_DOCKER_COMPOSE_PATH }} down
            
            echo \"üöÄ 3. Starting containers with rebuild...\"
            docker-compose -f ${{ secrets.API_GATEWAY_SERVER_DOCKER_COMPOSE_PATH }} up -d --build
            
            # Wait for services to start
            echo \"‚è≥ 4. Waiting for services to start...\"
            sleep 10
            
            # Check if containers are running
            echo \"üîç 5. Checking container status...\"
            docker-compose -f ${{ secrets.API_GATEWAY_SERVER_DOCKER_COMPOSE_PATH }} ps
            
            if [ \"\$LOG_BACKUP_CREATED\" = \"true\" ]; then
              echo \"‚úÖ Restart complete. Log backup available at: ~/\${LOGS_FILENAME}\"
            else
              echo \"‚úÖ Restart complete. No log backup created (no previous container was running).\"
            fi
          "
          
          # SSH into the server and execute the script
          sshpass -e ssh -o StrictHostKeyChecking=no -o LogLevel=QUIET -o ConnectTimeout=30 -T -p ${{ secrets.API_GATEWAY_SERVER_PORT }} ${{ secrets.API_GATEWAY_SERVER_USER }}@${{ secrets.API_GATEWAY_SERVER_HOST }} "$SCRIPT"
      
      - name: Notify completion
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "‚úÖ API Gateway restarted successfully"
          else
            echo "‚ùå Failed to restart API Gateway"
          fi